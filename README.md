# YGAI - AI 驱动的个人效率助手 (钉钉渠道版)

YGAI 是一个基于 Python 和 Django 构建的 AI 驱动的个人效率助手。它旨在解决日常工作中多渠道信息分散、任务无法闭环的痛点，通过接入钉钉渠道，利用大模型（阿里千问）对消息进行智能分类和处理，实现消息到待办事项（TodoList）以及文章到知识库（Knowledge Base）的自动转化。

---

## 1. 需求分析

### 1.1 背景与痛点
在日常工作中，我们每天会收到大量的碎片化信息（如钉钉、微信、邮件等）。这些信息中混合了闲聊、通知、重要任务、文章分享等。如果没有一个好的过滤机制，很容易因为信息过载而导致重要任务遗漏或响应不及时，优秀的知识文章也被淹没在聊天记录中。

### 1.2 核心目标
打造一个统一的智能信息处理中枢，实现以下闭环：
- **统一接收**：通过长链接（Stream 模式）稳定接收外部渠道（钉钉）的消息。
- **智能降噪**：AI 自动将消息分类为：紧急、重要、普通、可忽略。
- **任务闭环**：对紧急或重要的消息，自动提取任务要素（标题、时间），并生成系统内部的待办事项。
- **知识沉淀**：自动识别聊天中的链接（如微信公众号、小宇宙等），通过爬虫抓取网页并在后台使用 AI 进行深度阅读、打分和提取核心要点，自动存入 Notion 知识库。
- **智能响应**：对普通询问类消息进行自动化回复，减少人工介入。

### 1.3 核心用户场景
- **场景一（自动建任务）**：老板发来消息“明天下午3点前把项目方案发我”。系统识别为“重要”，自动提取截止时间“明天 15:00”，并在系统中创建 Todo，同时回复老板“✅ 已为您创建任务：整理项目方案”。
- **场景二（自动应答）**：同事发来消息“在吗？”或者简单的日常问候。系统识别为“普通”，AI 自动回复“您好，请问有什么可以帮您？”。
- **场景三（降噪过滤）**：群发通知或系统报警恢复通知。系统识别为“可忽略”，直接在后台归档，不再对用户进行推送打扰。
- **场景四（知识库收录）**：朋友分享了一篇关于 AI Agent 的长文链接。机器人自动提取链接，爬取正文，交给 AI 提炼出 3 条核心要点并给出质量评分（如 ⭐⭐⭐⭐）。随后将这些分析结论与文章 URL、发布时间自动存入 Notion 知识库，并向你回复摘要结果。如果发了重复链接，机器人还能秒回已存在的评分和摘要。

---

## 2. 架构设计

### 2.1 技术选型
- **基础框架**：Python 3.12 + Django 5.1 + Django REST Framework 3.16
- **爬虫与解析**：`httpx` (异步并发)、`BeautifulSoup4` (HTML DOM 解析)、正则表达式
- **AI 驱动层**：阿里云 DashScope SDK（千问模型 `qwen-plus` / `qwen-max`）
- **即时通讯接入**：DingTalk Stream SDK（基于 WebSocket，无需企业暴露公网 IP）
- **数据库同步**：Notion API (`notion-client`)
- **调度系统**：APScheduler
- **配置管理**：`django-environ`

### 2.2 系统架构
系统由四个核心模块构成：
1. **渠道层 (`apps/channel`)**：负责与外部平台（钉钉）进行鉴权、连接、收发消息。内置正则与爬虫引擎提取并抓取消息中的网页链接。
2. **AI 引擎层 (`apps/ai`)**：调用阿里云大模型实现意图分类 (`classifier`)、任务要素提取 (`extractor`)、文章深度总结评分 (`analyze_article_content`) 以及智能回复 (`responder`)。
3. **任务与知识管理层 (`apps/todo`)**：
   - **Todo 模块**：处理生成的待办事项，双向同步至 Notion Task 数据库。
   - **Knowledge 模块**：处理收录的文章和网页链接，利用 Notion Client 写入专属的 Notion KB 数据库，并在写入前执行查重阻断。
4. **定时通知层 (`apps/todo/scheduler.py`)**：基于 APScheduler 的后台调度器，定时从 Notion 数据库查询数据，结合 AI 生成周报、日报并推送到钉钉。

### 2.3 数据流转 (Workflow)
```text
钉钉用户发送消息
       │
       ▼
【钉钉 Stream Bot】收到 WebSocket 推送
       │
       ▼
【URL 拦截器】检查是否包含链接？
       ├─▶ 是 ──▶ 【知识库排重】 ──(不存在)──▶ 爬虫抓取网页 ──▶ AI 深度阅读评分与总结 ──▶ 存入 Notion 知识库
       │                                  │
       │                                  ▼
       │                          【任务提取拦截】 ──▶ 如果消息除了链接还有额外文字(如"请明天前看完")
       │                                  │
       ▼                                  ▼
调用 【AI 决策引擎】(apps/ai/classifier.py)
       │
       ├─▶ [urgent / important] ──▶ 调用 【AI 任务提取】 ──▶ 提取任务标题、描述、截止时间 ──▶ 写入 Notion Task ──▶ 合并回复："已创建任务/已收录链接"
       │
       ├─▶ [normal] ──────────────▶ 只有纯文本时调用 【AI 自动回复】 ──▶ 发送钉钉回复
       │
       └─▶ [ignore] ──────────────▶ 标记已处理，如果是链接分享则仅回复链接收录结果
```

### 2.4 定时通知流程

| 通知类型 | 触发时间 | 内容说明 |
|---------|---------|---------|
| 周报摘要 | 每周一 9:00 | AI 从所有未完成任务中提炼本周 5 个核心事项 |
| 每日要事 | 工作日 9:00（周一除外） | AI 选出当天最重要的 2 个事项及推进建议 |
| 到期提醒 | 每天 18:00 | 检查 24h 内即将到期和已过期任务，AI 给出处理建议 |
| 上周总结 | 每周一 17:00 | 统计上周已完成的任务，AI 自动生成专业工作总结 |

---

## 3. 使用说明

### 3.1 环境变量配置
复制环境模板并填写真实配置：
```bash
cp .env.example .env
```
修改 `.env` 文件，其中除了钉钉和 DashScope 的 Key，还**必须补全两个 Notion 数据库的 ID**：
```env
DJANGO_SECRET_KEY=your_secret_key_here
DJANGO_DEBUG=True
DINGTALK_APP_KEY=你的钉钉机器人AppKey
DINGTALK_APP_SECRET=你的钉钉机器人AppSecret
DASHSCOPE_API_KEY=你的阿里云DashScope API Key

# Notion 相关的配置
NOTION_API_KEY=你的Notion Integration Token
NOTION_DATABASE_ID=你的Notion任务(Task)数据库ID
NOTION_KB_DATABASE_ID=你的Notion知识库(Knowledge Base)数据库ID
DINGTALK_NOTIFY_USER_ID=接收定时通知的钉钉员工userId
```

### 3.2 Notion 数据库字段要求
为了让系统能成功将任务和文章分别写入你的 Notion，请确保你的数据库中包含以下确切名称和类型的列：

#### 1. 任务数据库 (`NOTION_DATABASE_ID`)
- **任务名称** (`Title`，主列)
- **描述** (`Rich text`)
- **优先级** (`Select`，可预设：高、中、低)
- **状态** (`Status`，须预设：全景时段（排任务、调优先级）、单核时段（当前执行）、已完成)
- **任务类型** (`Multi-select`，可预设：开发、设计、会议、其他等)
- **截止日期** (`Date`)

#### 2. 知识库数据库 (`NOTION_KB_DATABASE_ID`)
- **标题** (`Title`，主列)
- **URL** (`URL`)
- **来源** (`Rich text`)
- **概要** (`Rich text`)
- **状态** (`Status`，且内部必须预先创建一个名为 `未阅读` 的选项)
- **分类** (`Select`，可预设：AI, 产品, 技术, 生活, 管理, 其他)
- **评分** (`Select`，必须预设这五个选项：`⭐`, `⭐⭐`, `⭐⭐⭐`, `⭐⭐⭐⭐`, `⭐⭐⭐⭐⭐`)
- **日期** (`Date`)

### 3.3 运行启动
系统包含两个独立的进程，建议在两个终端窗口中分别运行：

**进程一：Django Web 服务（提供后台与 API）**
```bash
python manage.py runserver 0.0.0.0:8000
```

**进程二：钉钉消息监听与定时任务系统 (Stream 模式)**
```bash
./start_dingtalk_bot.sh
```
*(或者执行 `python manage.py run_dingtalk_bot` 并在另一个终端启动 APScheduler)*

启动成功后，即可在钉钉向机器人发送消息体验自动收录和任务规划！
